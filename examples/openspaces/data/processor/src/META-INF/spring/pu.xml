<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:os-core="http://www.openspaces.org/schema/core"
       xmlns:os-events="http://www.openspaces.org/schema/events"
       xmlns:os-remoting="http://www.openspaces.org/schema/remoting"
       xmlns:os-sla="http://www.openspaces.org/schema/sla"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
       http://www.openspaces.org/schema/core http://www.openspaces.org/schema/core/openspaces-core.xsd
       http://www.openspaces.org/schema/events http://www.openspaces.org/schema/events/openspaces-events.xsd
       http://www.openspaces.org/schema/remoting http://www.openspaces.org/schema/remoting/openspaces-remoting.xsd
       http://www.openspaces.org/schema/sla http://www.openspaces.org/schema/sla/openspaces-sla.xsd">

    <!--
        The SLA bean used when deploying this processing unit to the Service Grid.

        The SLA uses a partitioned schema with primary and backup. It will create 2
        partitions each with a single backup.

        The SLA bean also mandates that a primary and a backup won't run under the same
        GSC by setting the maxInstancesPerVM to 1.

        Within the SLA several Monitors can be defined which can then be viewed within the UI.
        This monitors (on top of the built in monitors such as CPU and Memory) can be used
        with a policy handler (not shown here).
    -->
    <os-sla:sla cluster-schema="partitioned-sync2backup" number-of-instances="2" number-of-backups="1"
                max-instances-per-vm="1">
        <os-sla:monitors>
            <os-sla:bean-property-monitor name="Processed Data"
                                          bean-ref="dataProcessedCounter" property-name="processedDataCount"/>
        </os-sla:monitors>
    </os-sla:sla>

    <!--
        Spring propery configurer which allows us to use system properties (such as user.name).
    -->
    <bean id="propertiesConfigurer" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"/>

    <context:annotation-config />

    <!--
        Scan for components (both Spring ones and OpenSpaces ones)
    -->
    <context:component-scan base-package="org.openspaces.example.data"/>

    <!--
        Enables the usage of @GigaSpaceContext annotation based injection.
    -->
    <os-core:giga-space-context/>
    
    <!--
        Enables using @Polling and @Notify annotations
    -->
    <os-events:annotation-support />

    <!--
        Enables using @RemotingService as well as @SyncProxy (and others) annotations
    -->
    <os-remoting:annotation-support />

    <!--
        A bean representing a space (an IJSpace implementation).

        Note, we do not specify here the cluster topology of the space. It is declated outside of
        the processing unit or within the SLA bean.
    -->
    <os-core:space id="space" url="/./space">
        <os-core:filter-provider ref="remotingServiceExporter"/>
    </os-core:space>

    <!--
        Defines a local Jini transaction manager.
    -->
    <os-core:local-tx-manager id="transactionManager" space="space"/>

    <!--
        OpenSpaces simplified space API built on top of IJSpace/JavaSpace.
    -->
    <os-core:giga-space id="gigaSpace" space="space" tx-manager="transactionManager"/>

    <!--
        A context loader loading a Spring applicaiton context defined by the location only when
        this processing unit instance is primary (in a primary backup scenario).
    -->
    <os-core:refreshable-context-loader id="modeExample" location="classpath:/META-INF/spring/mode/mode.xml"/>

    <os-remoting:service-exporter id="remotingServiceExporter">
        <os-remoting:service ref="modeExample"/>
    </os-remoting:service-exporter>

    <!--
        Remoting supprt exporting the data processor for remoting invocation using OpenSpaces Remoting.

        Note, remoting is based on the different event containers and provides an event listner that
        exports a list of services for remote invocations. In our case, the data processor is exposed.

        Also note, using notifications instead of polling takes is just a matter of configuraion. Changing
        to notify container means just changing the xml element name, and setting two attributes to true:
        perform-take-on-notify and ignore-event-on-null-take.
    -->
    <os-events:polling-container id="remotingContainer" giga-space="gigaSpace" concurrent-consumers="2">
        <os-events:listener ref="remotingServiceExporter"/>
    </os-events:polling-container>
</beans>